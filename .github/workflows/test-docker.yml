name: CI

on:
  #pull_request:
  push:
    branches:
      - master

jobs:
#  build_and_publish:
#    name: Docker Image
#    runs-on: ubuntu-20.04
#
#    steps:
#    - uses: actions/checkout@v2
#
#    - name: Create Docker Image
#      run: |
#        docker build -t edxapp_test -f test.Dockerfile .
#        docker tag edxapp_test ghcr.io/mzulqarnain1/edxapp:testing
#
#    - name: Upload Docker Image
#      run: |
#        echo ${{ secrets.CR_PASSWORD }} | docker login ghcr.io -u mzulqarnain1 --password-stdin
#        docker push ghcr.io/mzulqarnain1/edxapp:testing

  run-tests:
    name: Unit Tests
    #needs: build_and_publish
    runs-on: ubuntu-20.04
    strategy:
      matrix:
        include:
          - module-name: lms-1
            path: "lms/djangoapps/badges/ lms/djangoapps/branding/ lms/djangoapps/bulk_email/ lms/djangoapps/bulk_enroll/ lms/djangoapps/bulk_user_retirement/ lms/djangoapps/ccx/ lms/djangoapps/certificates/ lms/djangoapps/commerce/"
          - module-name: lms-2
            path: "lms/djangoapps/course_api/ lms/djangoapps/course_blocks/ lms/djangoapps/course_home_api/ lms/djangoapps/course_wiki/ lms/djangoapps/coursewarehistoryextended/ lms/djangoapps/dashboard/ lms/djangoapps/debug/"
          - module-name: lms-3
            path: "lms/djangoapps/courseware/"
          - module-name: lms-4
            path: "lms/djangoapps/discussion/ lms/djangoapps/edxnotes/ lms/djangoapps/email_marketing/ lms/djangoapps/experiments/"
          - module-name: lms-5
            path: "lms/djangoapps/gating/ lms/djangoapps/grades/ lms/djangoapps/instructor/ lms/djangoapps/instructor_analytics/"
          - module-name: lms-6
            path: "lms/djangoapps/instructor_task/ lms/djangoapps/learner_dashboard/ lms/djangoapps/lms_initialization/ lms/djangoapps/lms_xblock/ lms/djangoapps/lti_provider/ lms/djangoapps/mailing/ lms/djangoapps/mobile_api/ lms/djangoapps/monitoring/ lms/djangoapps/program_enrollments/ lms/djangoapps/rss_proxy lms/djangoapps/static_template_view/ lms/djangoapps/staticbook/ lms/djangoapps/support/ lms/djangoapps/survey/ lms/djangoapps/teams/ lms/djangoapps/tests/ lms/djangoapps/verify_student/ lms/envs/ lms/lib/ lms/tests.py"
          - module-name: cms-1
            path: "cms/djangoapps/api/ cms/djangoapps/cms_user_tasks/ cms/djangoapps/course_creators/ cms/djangoapps/export_course_metadata/ cms/djangoapps/maintenance/ cms/djangoapps/models/ cms/djangoapps/pipeline_js/ cms/djangoapps/xblock_config/ cms/envs/ cms/lib/"
          - module-name: cms-2
            path: "cms/djangoapps/contentstore/"
          - module-name: openedx-1
            path: "openedx/core/djangoapps/ace_common/ openedx/core/djangoapps/agreements/ openedx/core/djangoapps/api_admin/ openedx/core/djangoapps/auth_exchange/ openedx/core/djangoapps/bookmarks/ openedx/core/djangoapps/cache_toolbox/ openedx/core/djangoapps/catalog/ openedx/core/djangoapps/ccxcon/ openedx/core/djangoapps/certificates/ openedx/core/djangoapps/commerce/ openedx/core/djangoapps/common_initialization/ openedx/core/djangoapps/common_views/ openedx/core/djangoapps/config_model_utils/ openedx/core/djangoapps/content/ openedx/core/djangoapps/content_libraries/ openedx/core/djangoapps/contentserver/ openedx/core/djangoapps/cors_csrf/ openedx/core/djangoapps/course_date_signals/ openedx/core/djangoapps/course_groups/ openedx/core/djangoapps/coursegraph/ openedx/core/djangoapps/courseware_api/ openedx/core/djangoapps/crawlers/ openedx/core/djangoapps/credentials/ openedx/core/djangoapps/credit/ openedx/core/djangoapps/dark_lang/ openedx/core/djangoapps/debug/ openedx/core/djangoapps/demographics/ openedx/core/djangoapps/discussions/ openedx/core/djangoapps/django_comment_common/ openedx/core/djangoapps/embargo/ openedx/core/djangoapps/enrollments/ openedx/core/djangoapps/external_user_ids/"
          - module-name: openedx-2
            path: "openedx/core/djangoapps/geoinfo/ openedx/core/djangoapps/header_control/ openedx/core/djangoapps/heartbeat/ openedx/core/djangoapps/lang_pref/ openedx/core/djangoapps/models/ openedx/core/djangoapps/monkey_patch/ openedx/core/djangoapps/oauth_dispatch/ openedx/core/djangoapps/olx_rest_api/ openedx/core/djangoapps/password_policy/ openedx/core/djangoapps/plugin_api/ openedx/core/djangoapps/plugins/ openedx/core/djangoapps/profile_images/ openedx/core/djangoapps/programs/ openedx/core/djangoapps/safe_sessions/ openedx/core/djangoapps/schedules/ openedx/core/djangoapps/self_paced/ openedx/core/djangoapps/service_status/ openedx/core/djangoapps/session_inactivity_timeout/ openedx/core/djangoapps/signals/ openedx/core/djangoapps/site_configuration/ openedx/core/djangoapps/system_wide_roles/ openedx/core/djangoapps/theming/ openedx/core/djangoapps/user_api/ openedx/core/djangoapps/user_authn/ openedx/core/djangoapps/util/ openedx/core/djangoapps/verified_track_content/ openedx/core/djangoapps/video_config/ openedx/core/djangoapps/video_pipeline/ openedx/core/djangoapps/waffle_utils/ openedx/core/djangoapps/xblock/ openedx/core/djangoapps/xmodule_django/ openedx/core/djangoapps/zendesk_proxy/ openedx/core/djangolib/ openedx/core/lib/ openedx/core/tests/ openedx/core/tests/ openedx/features/ openedx/testing/ openedx/tests/"
          - module-name: common-1
            path: "common/djangoapps/"
          - module-name: common-2
            path: "common/lib/"
#        system: [ cms, common, openedx ]
#        shard: [ 1, 2, 3 ]

    steps:
    - uses: actions/checkout@v2

    - name: Download Docker Image
      run: |
        echo ${{ secrets.CR_PASSWORD }} | docker login ghcr.io -u mzulqarnain1 --password-stdin
        docker pull ghcr.io/mzulqarnain1/edxapp:testing

    - name: Docker Tests ${{ matrix.module-name }}
      continue-on-error: true
      run: |
        echo TEST_PATH=${{ matrix.path }} >> .env
#        echo SHARD=${{ matrix.shard }} >> .env
#        echo SPLITS=3 >> .env
        docker-compose --env-file .env -f test.docker-compose.yml up --abort-on-container-exit
      # docker run --env TEST_SYSTEM=${{ matrix.test-system }} --env EDXAPP_TEST_MONGO_HOST="host.docker.internal" ghcr.io/mzulqarnain1/edxapp:testing bash -c 'source /edx/app/edxapp/venvs/edxapp/bin/activate && pytest $TEST_SYSTEM'

#  tests-in-container:
#    runs-on: ubuntu-latest
#    container: ghcr.io/mzulqarnain1/edxapp:testing
#    steps:
#      - run: |
#          bash -c 'source /edx/app/edxapp/venvs/edxapp/bin/activate && cd /edx/app/edxapp/edx-platform && pytest cms/djangoapps/api/v1/tests/test_views/test_course_runs.py::CourseRunViewSetTests::test_update'
#        name: Run in container
